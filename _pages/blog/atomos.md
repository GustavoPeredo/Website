# AtomOS: Postmodern OS

How would a Linux Postmoder OS look like,
according to me (lol).

## Introduction

First and foremost, the design decisions of AtomOS are mostly made
by my opinion, this however doesn't mean they are ungrounded or
that can't be criticized. On the contrary, hearing adverse or favorable
opinions are great way to improve an idea.

In second place, although I was already working on this distribution
before I read [Fitting Everything Together](https://0pointer.net/blog/fitting-everything-together.html),
they have similar design decisions, you can read my opinion about it
[here, as well](/blog/re-fitting-everything-together).

Lastly, whether I'll actually finish building this distro or not,
is a matter of time and will. Although I think it would be very cool.
(UPDATE: I did not finish it, check out [AtomOS v2](/blog/atomos-v2) instead)

## Main Principles

 * Updates should be reversable (as well as factory reset).
 * The distribution should be remixable, allowing users and companies
 to remix it as they so wish.
 * All software in it should just work.
 * Shouldn't get in the way of the user.

## Partition scheme

The partition scheme of such distribution should be as follow:
![Parition Scheme for AtomOS](/images/Partitions-AtomOS.svg)

An encrypted system (recommended) is as follow:
![Parition Scheme for Encrypted AtomOS](/images/PartitionsE-AtomOS.svg)

In text:

 * /boot partition.
 * / System partition A (read only).
 * / System partition B (read only).
 * /home for user files and applications.
 * /var for logs and system files that are modified.
 * /nix for development and cli tools.
 is recommended for that).
 * An optional recovery partition (in case something goes wrong).
 * A snapshot partition to backup home directory (BTRFS).
 * An EFI partition to boot using UEFI.

All partitions should receive [Labels](https://www.pcmag.com/encyclopedia/term/volume-label)
so that [fstab](https://wiki.archlinux.org/title/Fstab)
doesn't need to be configured.

More about why these in the "System Boot" and "Updating/Modifying the system"
sections.

### Partition formatting
Bootloader-wise, [ext4](https://wiki.archlinux.org/title/Ext4)
and [fat-32](https://wiki.osdev.org/EFI_System_Partition) are standard choices.
Personally, I think it makes sense for non-encrypted system partitions to use
[SquashFS](https://en.wikipedia.org/wiki/SquashFS), since it is (AFAIK) the 
most well known read-only filesystem; finally all other partitions are under
[BTRFS subvolumes](https://btrfs.readthedocs.io/en/latest/Subvolumes.html).

## Installation process

The installation process of such distribution, would be as follow:

1. LiveCD boots to RAM.
2. Partitions are created, LUKS is opened.
3. An ISO containing the system image is downloaded (different than LiveCD).
4. [dd](https://linux.die.net/man/1/dd) is used to burn System ISO to
System partitions A and B and to burn LiveCD ISO to Recovery.
5. User is created and 
[home-manager](https://github.com/nix-community/home-manager) is installed
for that user.
6. Boot files are generated, with three boot options (Root A, Root B and 
Recovery).

## Updating/Modifying the System
Updating the system would be simple:

1. An ISO with a new version of the system is downloaded
2. The ISO is cloned to Root A

Modifying the system follows a similar process:

1. Generate a modified ISO of the system
2. Clone the ISO to Root A

![Visualization of update procedure](/images/AB-Update.svg)

If the update or installation is broken, then simply booting to Root B
will allow the user to have a working system.

This method of updating through images in two different partitions is known as
[A/B systme updates](https://source.android.com/devices/tech/ota/ab/),
it is used on [Android](https://source.android.com/devices/tech/ota/ab/),
[Steam Deck](https://www.reddit.com/r/SteamDeck/comments/uceblk/trivia_deck_has_ab_partition_scheme_similarly_to/)
and suggested by [Lennart Poettering](https://0pointer.net/blog/fitting-everything-together.html).

The main advantages are:

 * Updates don't affect current running system.
 * If something goes wrong, the user can simply rollback.
 * [dm-verity](https://source.android.com/security/verifiedboot/dm-verity) can
 be used to verify if the files are the expected ones.
 * Update is consistent and equal across all installs.

### Generating New ISOs

Ideally new updates would be generated by a script that would:

1. Download [Stage 3 tarballs](https://wiki.gentoo.org/wiki/Stage_tarball#Stage_3)
and unpack them to a folder.
2. [Chroot](https://wiki.archlinux.org/title/Chroot) into the folder.
3. Run a script that installs additional packages, enable 
[services](https://www.tutorialspoint.com/operating_system/os_services.htm),
create directories and configures /etc.
4. Leave chroot.
5. Package everything into an ISO.

An even better solution would be to run these as a [Docker](https://github.com/iximiuz/docker-to-linux)
or [Podman](https://podman.io/) containers, so steps that didn't change
can be cachaed.

Finally, some distros have tutorials/tools on how to do these (
[Arch](https://wiki.archlinux.org/title/Archiso),
[Arco](https://www.arcolinuxiso.com/), [Alpine](https://wiki.alpinelinux.org/wiki/How_to_make_a_custom_ISO_image)
and [Ubuntu](https://github.com/canonical/ubuntu-image)) and most people
would be able to create their own remixes and share them!

## System Boot

The operating system would have it's boot on a separate partition,
this partition will be used to unlock LUKS if encrypted and mount
the appropriate root partition (A or B) (as
[sysroot](https://man7.org/linux/man-pages/man7/bootup.7.html)) to an
[overlay tmpfs](https://www.jamescoyle.net/knowledge/1659-what-is-tmpfs).

An overlay tmpfs simply means the system is booted to RAM, this allows for
extremely fast software startup times and for safe configuration/software
tests (since all changes to the root partition are forgotten after a reboot).

## Software Management

Such OS would have three ways of managing software:

1. System Software (bundled in the ISO)
2. User/Dev Software (managed by nix)
3. Applications (installed by flatpak)

Software bundled by the ISO should be "essential" programs, in a desktop OS
I'd consider them: System utilities (file manager, settings, partition manager,
printing support, etc), user utilities (internet browser, text editor, image
viewer) and a desktop environment.

Other software that users might want to install or configured, can be installed
through nix or flatpak. I give reasons as for why and which one is better in
certain cases in [this blog post](/blog/nix-flatpak).

## AtomOS in practice

The closest I currently can get from having AtomOS actually working is
by having a variation of [Alpine Linux](https://alpinelinux.org/). As
mentioned before, Alpine Linux has [good instructions on making your own ISO](https://wiki.alpinelinux.org/wiki/How_to_make_a_custom_ISO_image_with_mkimage)
and [Jakob Jirutka](https://github.com/jirutka) wrote an 
[amazing tool](https://github.com/alpinelinux/alpine-make-vm-image) to make it
even easier; Alpine Linux also has a handy [overlaytmpfs boot option](https://gitlab.alpinelinux.org/alpine/mkinitfs/-/blob/master/initramfs-init.in)
to allow the System to boot to RAM. To finish off, Alpine Linux devs
made the System so compact that a full Desktop (flatpak, nix, plasma,
kde-applicaitons, networkmanager, pipewire, cups, firefox, zram and
video hardware acceleartion) weights around 1.2GB (WHAT?)!

The system is able to boot to RAM and to mount the home partition correctly in
a VM, I couldn't make it work on real hardware. Neither plasma-wayland nor
xorg seems to want to initializem, which is a shame.

Besides that, only a graphical interface to manage updates would be required.
Everything else already exists!

### The pros of AtomOS

* System is distributed for most users identically, therefore bugs/solutions are 
more general and less case specific.
* Promotes community contribution and remixes through easy ISO generation
and nix.
* The entire system runs on RAM, meaning it is more responsive.
* Works on both old and newer hardware.
* Seamless and safe updates.

### The cons of AtomOS

* Lacks some more advanced Systemd functionalities.
* Alpine development is not much focused on Desktop Linux.
